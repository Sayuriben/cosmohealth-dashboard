<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CosmoHealth Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap');
        * { font-family: 'Poppins', sans-serif; }
        .dashboard-title { font-family: 'Playfair Display', serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950">
    <div id="root" class="min-h-screen p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-12">
                <h1 class="dashboard-title text-6xl font-bold text-white mb-3">CosmoHealth</h1>
                <p class="text-slate-400 text-xl">Antibiotic De-escalation Intelligence Platform</p>
                <p class="text-slate-500 text-sm mt-2">Real-time analytics â€¢ Live from Google Sheets</p>
            </div>

            <!-- Loading State -->
            <div id="loading" class="text-center py-12">
                <div class="inline-block">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500"></div>
                </div>
                <p class="text-slate-400 mt-4">Loading dashboard...</p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard" class="hidden">
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-cyan-500 to-cyan-700 rounded-2xl p-8 shadow-2xl">
                        <p class="text-cyan-100 text-sm font-semibold uppercase">Total</p>
                        <p class="text-5xl font-bold text-white mt-3" id="total">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-500 to-emerald-700 rounded-2xl p-8 shadow-2xl">
                        <p class="text-emerald-100 text-sm font-semibold uppercase">Approved</p>
                        <p class="text-5xl font-bold text-white mt-3" id="approved">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-rose-500 to-rose-700 rounded-2xl p-8 shadow-2xl">
                        <p class="text-rose-100 text-sm font-semibold uppercase">Declined</p>
                        <p class="text-5xl font-bold text-white mt-3" id="declined">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-amber-500 to-amber-700 rounded-2xl p-8 shadow-2xl">
                        <p class="text-amber-100 text-sm font-semibold uppercase">Pending</p>
                        <p class="text-5xl font-bold text-white mt-3" id="pending">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-2xl p-8 shadow-2xl">
                        <p class="text-indigo-100 text-sm font-semibold uppercase">Approval %</p>
                        <p class="text-5xl font-bold text-white mt-3" id="approvalRate">0%</p>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-slate-800 rounded-2xl p-8 shadow-2xl">
                        <h2 class="text-2xl font-bold text-white mb-6">Approval Distribution</h2>
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div class="bg-slate-800 rounded-2xl p-8 shadow-2xl">
                        <h2 class="text-2xl font-bold text-white mb-6">By Antibiotic</h2>
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-slate-800 rounded-2xl p-8 shadow-2xl">
                    <h2 class="text-2xl font-bold text-white mb-6">Recent Recommendations</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-slate-700">
                                    <th class="text-left py-3 px-4 text-slate-400">Patient</th>
                                    <th class="text-left py-3 px-4 text-slate-400">Antibiotic</th>
                                    <th class="text-left py-3 px-4 text-slate-400">Decision</th>
                                    <th class="text-left py-3 px-4 text-slate-400">Confidence</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let pieChart, barChart;

        async function loadDashboard() {
            try {
                // Fetch directly from Sheety
                const response = await fetch('https://api.sheety.co/3f8ed38ec6cb4d5131024c60be0f9f80/antibioticDeEscalationAuditTrail/sheet1');
                const data = await response.json();
                const records = data.rows || [];

                console.log('Sheety response:', data);
                console.log('Records:', records);

                if (records.length === 0) {
                    document.getElementById('loading').innerHTML = '<p class="text-slate-400">No data available yet</p>';
                    return;
                }

                renderDashboard(records);
            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('loading').innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            }
        }

        function renderDashboard(records) {
            // Calculate metrics
            const total = records.length;
            const approved = records.filter(r => {
                const decision = (r.clinicianDecision || r['Clinician decision'] || '').toLowerCase();
                return decision === 'approve';
            }).length;
            const declined = records.filter(r => {
                const decision = (r.clinicianDecision || r['Clinician decision'] || '').toLowerCase();
                return decision === 'decline';
            }).length;
            const pending = total - approved - declined;
            const approvalRate = approved + declined > 0 ? Math.round((approved / (approved + declined)) * 100) : 0;

            // Update display
            document.getElementById('total').textContent = total;
            document.getElementById('approved').textContent = approved;
            document.getElementById('declined').textContent = declined;
            document.getElementById('pending').textContent = pending;
            document.getElementById('approvalRate').textContent = approvalRate + '%';

            // Group by antibiotic
            const byAntibiotic = {};
            records.forEach(r => {
                const abx = r.currentAbx || r['Current Abx'] || 'Unknown';
                if (!byAntibiotic[abx]) byAntibiotic[abx] = { approved: 0, declined: 0 };
                const decision = (r.clinicianDecision || r['Clinician decision'] || '').toLowerCase();
                if (decision === 'approve') byAntibiotic[abx].approved++;
                else if (decision === 'decline') byAntibiotic[abx].declined++;
            });

            // Create pie chart
            createPieChart(approved, declined, pending);
            
            // Create bar chart
            createBarChart(byAntibiotic);

            // Populate table
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = records.map(r => `
                <tr class="border-b border-slate-700 hover:bg-slate-700/50">
                    <td class="py-3 px-4 text-slate-200">${r.patientName || r['Patient Name'] || 'N/A'}</td>
                    <td class="py-3 px-4 text-slate-200">${r.currentAbx || r['Current Abx'] || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="${
                            (r.clinicianDecision || r['Clinician decision'] || '').toLowerCase() === 'approve' ? 'bg-emerald-500/20 text-emerald-400' :
                            (r.clinicianDecision || r['Clinician decision'] || '').toLowerCase() === 'decline' ? 'bg-rose-500/20 text-rose-400' :
                            'bg-amber-500/20 text-amber-400'
                        } px-2 py-1 rounded text-xs">
                            ${(r.clinicianDecision || r['Clinician decision'] || 'Pending').charAt(0).toUpperCase() + (r.clinicianDecision || r['Clinician decision'] || 'Pending').slice(1).toLowerCase()}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-slate-200">${Math.round((r['Ai confidence score'] || 0) * 100)}%</td>
                </tr>
            `).join('');

            // Show dashboard
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function createPieChart(approved, declined, pending) {
            const ctx = document.getElementById('pieChart').getContext('2d');
            if (pieChart) pieChart.destroy();
            pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Approved', 'Declined', 'Pending'],
                    datasets: [{
                        data: [approved, declined, pending],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderColor: '#1e293b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1' }
                        }
                    }
                }
            });
        }

        function createBarChart(byAntibiotic) {
            const ctx = document.getElementById('barChart').getContext('2d');
            if (barChart) barChart.destroy();
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(byAntibiotic),
                    datasets: [
                        {
                            label: 'Approved',
                            data: Object.values(byAntibiotic).map(v => v.approved),
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Declined',
                            data: Object.values(byAntibiotic).map(v => v.declined),
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#cbd5e1' } }
                    },
                    scales: {
                        y: { ticks: { color: '#94a3b8' }, grid: { color: '#475569' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { color: '#475569' } }
                    }
                }
            });
        }

        // Load dashboard
        loadDashboard();
        
        // Refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
