<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CosmoHealth Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap');
        * { font-family: 'Poppins', sans-serif; }
        .dashboard-title { font-family: 'Playfair Display', serif; }
        .stat-card { transition: transform 0.3s, box-shadow 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950">
    <div id="root" class="min-h-screen p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-12">
                <h1 class="dashboard-title text-6xl font-bold text-white mb-3">CosmoHealth</h1>
                <p class="text-slate-400 text-xl">Antibiotic De-escalation Intelligence Platform</p>
                <p class="text-slate-500 text-sm mt-2">Real-time analytics • Live from Google Sheets</p>
            </div>

            <!-- Loading State -->
            <div id="loading" class="text-center py-12">
                <div class="inline-block">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500"></div>
                </div>
                <p class="text-slate-400 mt-4">Loading dashboard...</p>
            </div>

            <!-- Dashboard Content (hidden until loaded) -->
            <div id="dashboard" class="hidden">
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <div class="stat-card bg-gradient-to-br from-cyan-500 to-cyan-700 rounded-2xl p-8 shadow-2xl border border-cyan-400/20">
                        <p class="text-cyan-100 text-sm font-semibold uppercase tracking-wide">Total Recommendations</p>
                        <p class="text-5xl font-bold text-white mt-3" id="total">0</p>
                        <div class="mt-4 h-1 bg-cyan-400 rounded-full w-12"></div>
                    </div>

                    <div class="stat-card bg-gradient-to-br from-emerald-500 to-emerald-700 rounded-2xl p-8 shadow-2xl border border-emerald-400/20">
                        <p class="text-emerald-100 text-sm font-semibold uppercase tracking-wide">Approved</p>
                        <p class="text-5xl font-bold text-white mt-3" id="approved">0</p>
                        <p class="text-emerald-200 text-xs mt-2" id="approvedPct">0%</p>
                    </div>

                    <div class="stat-card bg-gradient-to-br from-rose-500 to-rose-700 rounded-2xl p-8 shadow-2xl border border-rose-400/20">
                        <p class="text-rose-100 text-sm font-semibold uppercase tracking-wide">Declined</p>
                        <p class="text-5xl font-bold text-white mt-3" id="declined">0</p>
                        <p class="text-rose-200 text-xs mt-2" id="declinedPct">0%</p>
                    </div>

                    <div class="stat-card bg-gradient-to-br from-amber-500 to-amber-700 rounded-2xl p-8 shadow-2xl border border-amber-400/20">
                        <p class="text-amber-100 text-sm font-semibold uppercase tracking-wide">Pending</p>
                        <p class="text-5xl font-bold text-white mt-3" id="pending">0</p>
                        <p class="text-amber-200 text-xs mt-2" id="pendingPct">0%</p>
                    </div>

                    <div class="stat-card bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-2xl p-8 shadow-2xl border border-indigo-400/20">
                        <p class="text-indigo-100 text-sm font-semibold uppercase tracking-wide">Approval Rate</p>
                        <p class="text-5xl font-bold text-white mt-3" id="approvalRate">0%</p>
                        <div class="mt-4 h-1 bg-indigo-400 rounded-full w-12"></div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Pie Chart -->
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 shadow-2xl border border-slate-700">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <span class="w-2 h-2 bg-cyan-500 rounded-full mr-3"></span>
                            Decision Distribution
                        </h2>
                        <div class="h-80">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>

                    <!-- Bar Chart -->
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 shadow-2xl border border-slate-700">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <span class="w-2 h-2 bg-emerald-500 rounded-full mr-3"></span>
                            Decisions by Antibiotic
                        </h2>
                        <div class="h-80">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Additional Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Ward Distribution -->
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 shadow-2xl border border-slate-700">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <span class="w-2 h-2 bg-rose-500 rounded-full mr-3"></span>
                            Decisions by Ward
                        </h2>
                        <div class="h-80">
                            <canvas id="wardChart"></canvas>
                        </div>
                    </div>

                    <!-- Confidence Distribution -->
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 shadow-2xl border border-slate-700">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <span class="w-2 h-2 bg-amber-500 rounded-full mr-3"></span>
                            AI Confidence Scores
                        </h2>
                        <div class="h-80">
                            <canvas id="confidenceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 shadow-2xl border border-slate-700 mb-8">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                        <span class="w-2 h-2 bg-indigo-500 rounded-full mr-3"></span>
                        Recent Recommendations
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b-2 border-slate-700">
                                    <th class="text-left py-4 px-6 text-slate-300 font-semibold">Patient</th>
                                    <th class="text-left py-4 px-6 text-slate-300 font-semibold">Antibiotic</th>
                                    <th class="text-left py-4 px-6 text-slate-300 font-semibold">Recommendation</th>
                                    <th class="text-left py-4 px-6 text-slate-300 font-semibold">Decision</th>
                                    <th class="text-left py-4 px-6 text-slate-300 font-semibold">Confidence</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr><td colspan="5" class="py-8 px-6 text-center text-slate-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Footer -->
                <div class="text-center py-8 text-slate-500 text-sm border-t border-slate-700">
                    <p>CosmoHealth Dashboard • Real-time Antibiotic De-escalation Intelligence System</p>
                    <p class="mt-2 text-slate-600">Updates every 30 seconds</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let pieChart, barChart, wardChart, confidenceChart;

        async function loadDashboard() {
            try {
                const response = await fetch('/api/getData');
                const json = await response.json();
                const records = json.rows || [];
                
                if (records.length === 0) {
                    document.getElementById('loading').innerHTML = '<p class="text-slate-400 text-lg">No data available yet</p>';
                    return;
                }

                renderDashboard(records);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `<p class="text-red-400">Error loading data: ${error.message}</p>`;
            }
        }

        function renderDashboard(records) {
            // Calculate metrics
            const total = records.length;
            const approved = records.filter(r => (r.clinicianDecision || '').toLowerCase() === 'approve').length;
            const declined = records.filter(r => (r.clinicianDecision || '').toLowerCase() === 'decline').length;
            const pending = total - approved - declined;
            const approvalRate = approved + declined > 0 ? Math.round((approved / (approved + declined)) * 100) : 0;

            // Update metrics
            document.getElementById('total').textContent = total;
            document.getElementById('approved').textContent = approved;
            document.getElementById('declined').textContent = declined;
            document.getElementById('pending').textContent = pending;
            document.getElementById('approvalRate').textContent = approvalRate + '%';
            document.getElementById('approvedPct').textContent = `${approved + declined > 0 ? Math.round((approved / (approved + declined)) * 100) : 0}%`;
            document.getElementById('declinedPct').textContent = `${approved + declined > 0 ? Math.round((declined / (approved + declined)) * 100) : 0}%`;
            document.getElementById('pendingPct').textContent = `${total > 0 ? Math.round((pending / total) * 100) : 0}%`;

            // Group by antibiotic
            const byAntibiotic = {};
            records.forEach(r => {
                const abx = r.currentAbx || 'Unknown';
                if (!byAntibiotic[abx]) byAntibiotic[abx] = { approved: 0, declined: 0 };
                const decision = (r.clinicianDecision || '').toLowerCase();
                if (decision === 'approve') byAntibiotic[abx].approved++;
                else if (decision === 'decline') byAntibiotic[abx].declined++;
            });

            // Group by ward
            const byWard = {};
            records.forEach(r => {
                const ward = (r.patientId || 'Unknown').substring(0, 3);
                if (!byWard[ward]) byWard[ward] = { approved: 0, declined: 0 };
                const decision = (r.clinicianDecision || '').toLowerCase();
                if (decision === 'approve') byWard[ward].approved++;
                else if (decision === 'decline') byWard[ward].declined++;
            });

            // Create charts
            createPieChart(approved, declined, pending);
            createBarChart(byAntibiotic);
            createWardChart(byWard);
            createConfidenceChart(records);

            // Populate table
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = records.slice(0, 10).map((row, idx) => `
                <tr class="border-b border-slate-700 hover:bg-slate-700/50 transition-colors">
                    <td class="py-4 px-6 text-slate-200">${row.patientName || 'N/A'}</td>
                    <td class="py-4 px-6 text-slate-200">${row.currentAbx || 'N/A'}</td>
                    <td class="py-4 px-6 text-slate-300 text-xs">${row['De-escalation rec'] || 'N/A'}</td>
                    <td class="py-4 px-6">
                        <span class="${
                            (row.clinicianDecision || '').toLowerCase() === 'approve' ? 'bg-emerald-500/20 text-emerald-400' :
                            (row.clinicianDecision || '').toLowerCase() === 'decline' ? 'bg-rose-500/20 text-rose-400' :
                            'bg-amber-500/20 text-amber-400'
                        } px-3 py-1 rounded-full text-xs font-semibold">
                            ${(row.clinicianDecision || 'Pending').charAt(0).toUpperCase() + (row.clinicianDecision || 'Pending').slice(1).toLowerCase()}
                        </span>
                    </td>
                    <td class="py-4 px-6 text-slate-200">${Math.round((row['Ai confidence score'] || 0) * 100)}%</td>
                </tr>
            `).join('');

            // Show dashboard
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function createPieChart(approved, declined, pending) {
            const ctx = document.getElementById('pieChart').getContext('2d');
            if (pieChart) pieChart.destroy();
            pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Approved', 'Declined', 'Pending'],
                    datasets: [{
                        data: [approved, declined, pending],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderColor: ['#059669', '#dc2626', '#d97706'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#cbd5e1', font: { size: 12 } } } }
                }
            });
        }

        function createBarChart(byAntibiotic) {
            const ctx = document.getElementById('barChart').getContext('2d');
            if (barChart) barChart.destroy();
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(byAntibiotic),
                    datasets: [
                        {
                            label: 'Approved',
                            data: Object.values(byAntibiotic).map(v => v.approved),
                            backgroundColor: '#10b981',
                            borderColor: '#059669',
                            borderWidth: 1
                        },
                        {
                            label: 'Declined',
                            data: Object.values(byAntibiotic).map(v => v.declined),
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#cbd5e1' } } },
                    scales: { x: { ticks: { color: '#94a3b8' }, grid: { color: '#475569' } }, y: { ticks: { color: '#94a3b8' }, grid: { color: '#475569' } } }
                }
            });
        }

        function createWardChart(byWard) {
            const ctx = document.getElementById('wardChart').getContext('2d');
            if (wardChart) wardChart.destroy();
            wardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(byWard),
                    datasets: [
                        {
                            label: 'Approved',
                            data: Object.values(byWard).map(v => v.approved),
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Declined',
                            data: Object.values(byWard).map(v => v.declined),
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#cbd5e1' } } },
                    scales: { y: { ticks: { color: '#94a3b8' }, grid: { color: '#475569' } }, x: { ticks: { color: '#94a3b8' }, grid: { color: '#475569' } } }
                }
            });
        }

        function createConfidenceChart(records) {
            const ctx = document.getElementById('confidenceChart').getContext('2d');
            if (confidenceChart) confidenceChart.destroy();
            const confidenceData = records.map(r => (r['Ai confidence score'] || 0) * 100).slice(0, 20);
            confidenceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: confidenceData.length}, (_, i) => i + 1),
                    datasets: [{
                        label: 'Confidence %',
                        data: confidenceData,
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointBackgroundColor: '#06b6d4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#cbd5e1' } } },
                    scales: { y: { ticks: { color: '#94a3b8' }, grid: { color: '#475569' }, min: 0, max: 100 }, x: { ticks: { color: '#94a3b8' }, grid: { color: '#475569' } } }
                }
            });
        }

        // Load on init and refresh every 30 seconds
        loadDashboard();
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
